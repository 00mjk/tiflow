---
name: unique-task-name
task-mode: all  # full/incremental/all
flavor: mysql  # mysql/mariadb

target-database:
  host: "192.168.0.1"
  port: 4000
  user: "root"
  password: ""

MySQL-instances:             # one or more source database, config more source database for sharding merge
  -
    config:
      host: "192.168.0.2"
      port: 3306
      user: "root"
      password: ""
    server-id: 101           # unique in all instances
    meta:
      binlog-name: binlog-00001
      binlog-pos: 4
    route-rules: ["user-route-rules"]
    filter-rules: ["user-filter-1", "user-filter-2"]
    column-mapping-rules: ["user-column-mapping"]

    # `mydumper-config-name` and `mydumper` should only set one
    mydumper-config-name: "global"   # ref `mydumpers` config
#    mydumper:
#      mydumper-path: "./mydumper"
#      threads: 16

    # `loader-config-name` and `loader` should only set one
    loader-config-name: "global"    # ref `loaders` config
    #loader:                  # local loader rule
    #  pool-size: 32
    # `syncer-config-name` and `syncer` should only set one

    syncer-config-name: "global"    # ref `syncers` config
    #syncer:
    #  meta: "./data/syncer.meta"

  -
    config:
      host: "192.168.0.3"
      port: 3306
      user: "root"
      password: ""
    server-id: 102
    meta:
      binlog-name: binlog-00001
      binlog-pos: 320
    route-rules: ["user-route-rules"]
    filter-rules: ["user-filter-2"]
    column-mapping-rules: ["user-column-mapping"]

    mydumper:
      mydumper-path: "./mydumper"
      threads: 4
      chunk-filesize: 8
      skip-tz-utc: true
#      extra-args: "-B test -T t1,t2"

    loader:                  # local loader rule
      pool-size: 32
      dir: "./data/"
      checkpoint-schema: "tidb_loader"
      alternative-db: ""
      source-db: ""
      rm-checkpoint: false

    syncer:
      meta: "./data/syncer.meta"
      worker-count: 32
      batch: 2000
      max-retry: 200
      enable-gtid: false
      auto-fix-gtid: false
      disable-detect: false
      safe-mode: false

# other common configs shared by all instances

routes:                      # schema/table route mapping
  user-route-rules:
    pattern-schema: "user_*"
    pattern-table: "abc_*"
    target-schema: "user"
    target-table: "abc"

filters:                     # filter rules, mysql instance can ref rules in it
  user-filter-1:
    pattern-schema: "user_*"
    pattern-table: "abc_*"
    do-statement: ["ALL"]               # white list
    skip-statement: ["TRUNCATE TABLE"]  # black list
  user-filter-2:
    pattern-schema: "user_*"
    pattern-table: "abc_*"
    do-statement: ["ALL"]               # white list

column-mappings:             # column mapping rules, mysql instance can ref rules in it
  user-column-mapping:
    pattern-schema: "test_*"
    pattern-table: "abc_*"
    op: "add-column"       # add/ignore/modify -column
    source-column: "id"
    target-column: "id"
    expression: "add prefix"
    arguments: ["instance ID"]
    sql: "alter table xx modify column xxx"

mydumpers:                   # mydumper process unit specific configs, mysql instance can ref one config in it
  global:
    mydumper-path: "./mydumper"
    threads: 16
    chunk-filesize: 64
    skip-tz-utc: true
    extra-args: "-B test -T t1,t2 --no-locks"

loaders:                     # loader process unit specific configs, mysql instance can ref one config in it
  global:
    pool-size: 16
    dir: "./"
    checkpoint-schema: "tidb_loader"
    alternative-db: ""
    source-db: ""
    rm-checkpoint: false

syncers:                     # syncer process unit specific configs, mysql instance can ref one config in it
  global:
    meta: "./syncer.meta"
    worker-count: 16
    batch: 1000
    max-retry: 100
    enable-gtid: false
    auto-fix-gtid: false
    disable-detect: false
    safe-mode: false
